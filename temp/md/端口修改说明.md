# ğŸ”§ ç«¯å£ä¿®æ”¹è¯´æ˜

## ğŸ“Š ç«¯å£å˜æ›´

### ä¿®æ”¹å‰
- **åç«¯**ï¼šå®¹å™¨å†… 3001 â†’ å®¿ä¸»æœº 1201
- **å‰ç«¯**ï¼šå®¹å™¨å†… 80 â†’ å®¿ä¸»æœº 1280

### ä¿®æ”¹å âœ…
- **åç«¯**ï¼šå®¹å™¨å†… 1281 â†’ å®¿ä¸»æœº 1281
- **å‰ç«¯**ï¼šå®¹å™¨å†… 1280 â†’ å®¿ä¸»æœº 1280

---

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶æ¸…å•

### 1. Docker é…ç½®
- âœ… `docker-compose.yml`
  - backend ports: `1281:1281`
  - backend PORTç¯å¢ƒå˜é‡: `1281`
  - backend healthcheck: `localhost:1281`
  - frontend ports: `1280:1280`
  - frontend healthcheck: `localhost:1280`

### 2. åç«¯é…ç½®
- âœ… `backend/src/index.ts`
  - é»˜è®¤ç«¯å£: `1281`
  
- âœ… `backend/Dockerfile`
  - ENV PORT: `1281`
  - EXPOSE: `1281`

### 3. å‰ç«¯é…ç½®
- âœ… `frontend/nginx.conf`
  - listen: `1280`
  - proxy_pass (api): `http://backend:1281`
  - proxy_pass (books): `http://backend:1281`

- âœ… `frontend/Dockerfile`
  - EXPOSE: `1280`

- âœ… `frontend/vite.config.ts`
  - proxy target (api): `http://localhost:1281`
  - proxy target (books): `http://localhost:1281`
  - proxy target (covers): `http://localhost:1281`

### 4. éƒ¨ç½²è„šæœ¬
- âœ… `redeploy.sh`
  - åç«¯å¥åº·æ£€æŸ¥: `localhost:1281`
  
- âœ… `docker-status.sh`
  - åç«¯å¥åº·æ£€æŸ¥: `localhost:1281`

---

## ğŸš€ éƒ¨ç½²æ–¹æ³•

### æ–¹å¼1: ä½¿ç”¨è„šæœ¬ï¼ˆæ¨èï¼‰

```bash
cd /Users/ttbye/MyCODE/KnowBooks

# å®Œæ•´é‡æ–°éƒ¨ç½²
./redeploy.sh

# æˆ–å¿«é€Ÿéƒ¨ç½²
./deploy-quick.sh
```

### æ–¹å¼2: æ‰‹åŠ¨éƒ¨ç½²

```bash
cd /Users/ttbye/MyCODE/KnowBooks

# åœæ­¢å®¹å™¨
docker-compose down

# é‡æ–°æ„å»ºï¼ˆæ— ç¼“å­˜ï¼‰
docker-compose build --no-cache

# å¯åŠ¨å®¹å™¨
docker-compose up -d

# ç­‰å¾…30ç§’
sleep 30

# æ£€æŸ¥çŠ¶æ€
docker-compose ps
```

---

## âœ… éªŒè¯æ­¥éª¤

### 1. æ£€æŸ¥å®¹å™¨çŠ¶æ€

```bash
docker-compose ps
```

**é¢„æœŸè¾“å‡º**ï¼š

```
NAME                  STATUS      PORTS
knowbooks-backend     running     0.0.0.0:1281->1281/tcp
knowbooks-frontend    running     0.0.0.0:1280->1280/tcp
```

### 2. æµ‹è¯•åç«¯

```bash
# å¥åº·æ£€æŸ¥
curl http://localhost:1281/api/health

# é¢„æœŸè¾“å‡º
{"status":"ok","timestamp":"2025-12-11T..."}
```

### 3. æµ‹è¯•å‰ç«¯

```bash
# HTTPçŠ¶æ€æ£€æŸ¥
curl -I http://localhost:1280

# é¢„æœŸè¾“å‡º
HTTP/1.1 200 OK
```

### 4. æµ‹è¯•APIä»£ç†

```bash
# é€šè¿‡å‰ç«¯è®¿é—®åç«¯API
curl http://localhost:1280/api/health

# é¢„æœŸè¾“å‡º
{"status":"ok","timestamp":"2025-12-11T..."}
```

### 5. æµè§ˆå™¨è®¿é—®

- **æœ¬åœ°è®¿é—®**ï¼šhttp://localhost:1280
- **è¿œç¨‹è®¿é—®**ï¼šhttps://vlistttbye.i234.me:12280

---

## ğŸ” ç«¯å£è¯´æ˜

### å®¹å™¨å†…éƒ¨ç«¯å£

- **åç«¯å®¹å™¨å†…**ï¼šç›‘å¬ `1281`
- **å‰ç«¯å®¹å™¨å†…**ï¼šç›‘å¬ `1280`

### Docker æ˜ å°„

- **åç«¯æ˜ å°„**ï¼šå®¿ä¸»æœº `1281` â†’ å®¹å™¨ `1281`
- **å‰ç«¯æ˜ å°„**ï¼šå®¿ä¸»æœº `1280` â†’ å®¹å™¨ `1280`

### ç½‘ç»œé€šä¿¡

```
æµè§ˆå™¨ â†’ å‰ç«¯(1280) â†’ Nginx â†’ åç«¯(backend:1281)
   â†“
Dockerç½‘ç»œå†…éƒ¨é€šä¿¡ï¼šfrontendå®¹å™¨ â†’ backendå®¹å™¨
```

### å†…éƒ¨é€šä¿¡è¯´æ˜

- å‰ç«¯Nginxä»£ç†åˆ°åç«¯ä½¿ç”¨ **å®¹å™¨å** `backend:1281`
- Dockerå†…éƒ¨ç½‘ç»œè‡ªåŠ¨è§£æå®¹å™¨ååˆ°IP
- ä¸éœ€è¦ä½¿ç”¨ `localhost`

---

## ğŸ› å¸¸è§é—®é¢˜

### Q1: ç«¯å£è¢«å ç”¨æ€ä¹ˆåŠï¼Ÿ

```bash
# æ£€æŸ¥ç«¯å£å ç”¨
lsof -i :1280
lsof -i :1281

# åœæ­¢å ç”¨çš„è¿›ç¨‹
kill -9 <PID>

# æˆ–ä¿®æ”¹ç«¯å£ï¼ˆåœ¨docker-compose.ymlä¸­ï¼‰
```

### Q2: å®¹å™¨å¯åŠ¨ä½†æ— æ³•è®¿é—®ï¼Ÿ

```bash
# æ£€æŸ¥å®¹å™¨æ—¥å¿—
docker-compose logs backend
docker-compose logs frontend

# æ£€æŸ¥ç½‘ç»œ
docker network ls
docker network inspect knowbooks_knowbooks-network
```

### Q3: Nginx 502 Bad Gatewayï¼Ÿ

**åŸå› **ï¼šNginxæ— æ³•è¿æ¥åˆ°åç«¯

**æ£€æŸ¥**ï¼š
1. åç«¯å®¹å™¨æ˜¯å¦è¿è¡Œï¼Ÿ`docker-compose ps`
2. åç«¯ç«¯å£æ˜¯å¦æ­£ç¡®ï¼Ÿåº”è¯¥æ˜¯ `backend:1281`
3. å®¹å™¨æ˜¯å¦åœ¨åŒä¸€ç½‘ç»œï¼Ÿæ£€æŸ¥ `networks` é…ç½®

### Q4: å¼€å‘ç¯å¢ƒå¦‚ä½•é…ç½®ï¼Ÿ

**æœ¬åœ°å¼€å‘**ï¼š
```bash
# åç«¯
cd backend
PORT=1281 npm run dev

# å‰ç«¯
cd frontend
npm run dev  # ä¼šè‡ªåŠ¨ä»£ç†åˆ° localhost:1281
```

---

## ğŸ“ æ³¨æ„äº‹é¡¹

### 1. é‡æ–°æ„å»ºå¿…éœ€

ç«¯å£ä¿®æ”¹éœ€è¦é‡æ–°æ„å»ºé•œåƒï¼Œä¸èƒ½åªé‡å¯ï¼š

```bash
# âŒ é”™è¯¯ï¼šåªé‡å¯ä¸ä¼šç”Ÿæ•ˆ
docker-compose restart

# âœ… æ­£ç¡®ï¼šéœ€è¦é‡æ–°æ„å»º
docker-compose down
docker-compose build --no-cache
docker-compose up -d
```

### 2. é…ç½®ä¸€è‡´æ€§

ç¡®ä¿ä»¥ä¸‹é…ç½®ä¸€è‡´ï¼š
- `docker-compose.yml` ä¸­çš„ PORT ç¯å¢ƒå˜é‡
- `backend/src/index.ts` ä¸­çš„é»˜è®¤ç«¯å£
- `frontend/nginx.conf` ä¸­çš„ proxy_pass
- `frontend/vite.config.ts` ä¸­çš„ proxy target

### 3. åå‘ä»£ç†é…ç½®

å¦‚æœä½¿ç”¨ Nginx æˆ– Caddy ç­‰åå‘ä»£ç†ï¼š

```nginx
# åŸæ¥çš„é…ç½®ï¼ˆéœ€è¦ä¿®æ”¹ï¼‰
proxy_pass http://localhost:1201;  # âŒ æ—§ç«¯å£

# æ–°çš„é…ç½®
proxy_pass http://localhost:1281;  # âœ… æ–°ç«¯å£
```

---

## ğŸ¯ å¿«é€Ÿå‚è€ƒ

### ä¸€é”®éƒ¨ç½²

```bash
./redeploy.sh
```

### å¿«é€Ÿæ£€æŸ¥

```bash
# æ£€æŸ¥çŠ¶æ€
./docker-status.sh

# æŸ¥çœ‹æ—¥å¿—
./docker-logs.sh
```

### è®¿é—®åœ°å€

- **å‰ç«¯ï¼ˆæœ¬åœ°ï¼‰**ï¼šhttp://localhost:1280
- **åç«¯ï¼ˆæœ¬åœ°ï¼‰**ï¼šhttp://localhost:1281
- **å‰ç«¯ï¼ˆè¿œç¨‹ï¼‰**ï¼šhttps://vlistttbye.i234.me:12280

### å¥åº·æ£€æŸ¥

```bash
# åç«¯
curl http://localhost:1281/api/health

# å‰ç«¯ï¼ˆé€šè¿‡ä»£ç†è®¿é—®åç«¯ï¼‰
curl http://localhost:1280/api/health
```

---

## âœ… ä¿®æ”¹å®Œæˆ

æ‰€æœ‰ç«¯å£é…ç½®å·²ç»Ÿä¸€ä¿®æ”¹å®Œæˆï¼

**ä¿®æ”¹æ—¥æœŸ**ï¼š2025-12-11  
**ç‰ˆæœ¬**ï¼šv1.3.0  
**çŠ¶æ€**ï¼šâœ… å·²å®Œæˆï¼Œå¾…éƒ¨ç½²æµ‹è¯•

