# âœ… å®Œæˆæ€»ç»“ - ç«¯å£ä¿®æ”¹

## ğŸ¯ ç”¨æˆ·éœ€æ±‚

> "é‡æ–°å°†ä¿®æ”¹å‰åç«¯é»˜è®¤ç«¯å£ï¼Œå‰ç«¯ï¼š1280 dockeræ˜ å°„åˆ°1280 åç«¯ï¼š1281 dockeræ˜ å°„åˆ°1281,è¯·ä¿®æ”¹æ‰€æœ‰åœ°æ–¹çš„ç«¯å£"

**å·²å®Œæˆï¼âœ…**

---

## ğŸ“Š ç«¯å£å˜æ›´è¯¦æƒ…

### ä¿®æ”¹å‰ï¼ˆæ—§é…ç½®ï¼‰

```
åç«¯ï¼šå®¹å™¨å†… 3001 â†’ å®¿ä¸»æœº 1201
å‰ç«¯ï¼šå®¹å™¨å†… 80   â†’ å®¿ä¸»æœº 1280
```

### ä¿®æ”¹åï¼ˆæ–°é…ç½®ï¼‰âœ…

```
åç«¯ï¼šå®¹å™¨å†… 1281 â†’ å®¿ä¸»æœº 1281
å‰ç«¯ï¼šå®¹å™¨å†… 1280 â†’ å®¿ä¸»æœº 1280
```

---

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶æ¸…å•

### âœ… Docker é…ç½®ï¼ˆ3ä¸ªæ–‡ä»¶ï¼‰

1. **docker-compose.yml**
   - backend ports: `1201:3001` â†’ `1281:1281`
   - backend PORTç¯å¢ƒå˜é‡: `3001` â†’ `1281`
   - backend healthcheck: `localhost:3001` â†’ `localhost:1281`
   - frontend ports: `1280:80` â†’ `1280:1280`
   - frontend healthcheck: `localhost/` â†’ `localhost:1280/`

2. **backend/Dockerfile**
   - ENV PORT: `3001` â†’ `1281`
   - EXPOSE: `3001` â†’ `1281`

3. **frontend/Dockerfile**
   - EXPOSE: `80` â†’ `1280`

---

### âœ… åº”ç”¨é…ç½®ï¼ˆ3ä¸ªæ–‡ä»¶ï¼‰

4. **backend/src/index.ts**
   ```typescript
   // ä¿®æ”¹å‰
   const PORT = parseInt(process.env.PORT || '3001', 10);
   
   // ä¿®æ”¹å
   const PORT = parseInt(process.env.PORT || '1281', 10);
   ```

5. **frontend/nginx.conf**
   ```nginx
   # ä¿®æ”¹å‰
   listen 80;
   proxy_pass http://backend:3001;
   
   # ä¿®æ”¹å
   listen 1280;
   proxy_pass http://backend:1281;
   ```
   - ä¿®æ”¹äº†3å¤„ proxy_passï¼ˆ/apiã€/booksï¼‰

6. **frontend/vite.config.ts**
   ```typescript
   // ä¿®æ”¹å‰
   target: 'http://localhost:3001'
   
   // ä¿®æ”¹å
   target: 'http://localhost:1281'
   ```
   - ä¿®æ”¹äº†3å¤„ä»£ç†é…ç½®ï¼ˆ/apiã€/booksã€/api/coversï¼‰

---

### âœ… éƒ¨ç½²è„šæœ¬ï¼ˆ2ä¸ªæ–‡ä»¶ï¼‰

7. **redeploy.sh**
   - åç«¯å¥åº·æ£€æŸ¥: `localhost:3001` â†’ `localhost:1281`

8. **docker-status.sh**
   - åç«¯å¥åº·æ£€æŸ¥: `localhost:3001` â†’ `localhost:1281`

---

## ğŸ“ æ–°å¢çš„æ–‡æ¡£ï¼ˆ3ä¸ªæ–‡ä»¶ï¼‰

9. **ç«¯å£ä¿®æ”¹è¯´æ˜.md** - è¯¦ç»†è¯´æ˜æ–‡æ¡£
10. **ç«¯å£ä¿®æ”¹-å¿«é€Ÿå‚è€ƒ.md** - å¿«é€Ÿå‚è€ƒå¡
11. **å®Œæˆæ€»ç»“-ç«¯å£ä¿®æ”¹-20251211.md** - æœ¬æ–‡ä»¶

---

## âœ… ç¼–è¯‘æµ‹è¯•

### åç«¯ç¼–è¯‘
```bash
cd backend && npm run build
```
**ç»“æœ**ï¼šâœ… æˆåŠŸï¼Œæ— é”™è¯¯

### å‰ç«¯ç¼–è¯‘
```bash
cd frontend && npm run build
```
**ç»“æœ**ï¼šâœ… æˆåŠŸï¼Œæ— é”™è¯¯

---

## ğŸš€ éƒ¨ç½²æ–¹æ³•

### æ–¹å¼1: ä½¿ç”¨è„šæœ¬ï¼ˆæ¨èï¼‰â­

```bash
cd /Users/ttbye/MyCODE/KnowBooks

# å®Œæ•´é‡æ–°éƒ¨ç½²ï¼ˆäº¤äº’å¼ï¼‰
./redeploy.sh

# å¿«é€Ÿéƒ¨ç½²ï¼ˆæ— äº¤äº’ï¼‰
./deploy-quick.sh
```

### æ–¹å¼2: æ‰‹åŠ¨éƒ¨ç½²

```bash
cd /Users/ttbye/MyCODE/KnowBooks

# 1. åœæ­¢å®¹å™¨
docker-compose down

# 2. é‡æ–°æ„å»ºï¼ˆæ— ç¼“å­˜ï¼‰
docker-compose build --no-cache

# 3. å¯åŠ¨å®¹å™¨
docker-compose up -d

# 4. ç­‰å¾…30ç§’
sleep 30

# 5. æ£€æŸ¥çŠ¶æ€
docker-compose ps
./docker-status.sh
```

### æ–¹å¼3: è¿œç¨‹æœåŠ¡å™¨éƒ¨ç½²

```bash
# SSHç™»å½•åˆ°è¿œç¨‹æœåŠ¡å™¨
ssh user@vlistttbye.i234.me

# è¿›å…¥é¡¹ç›®ç›®å½•
cd /volume5/docker/bookpath/install

# æ‹‰å–æœ€æ–°ä»£ç 
git pull

# ä½¿ç”¨éƒ¨ç½²è„šæœ¬
./redeploy.sh
# æˆ–
./deploy-quick.sh
```

---

## âœ… éªŒè¯æ­¥éª¤

### 1. æ£€æŸ¥å®¹å™¨çŠ¶æ€

```bash
docker-compose ps
```

**é¢„æœŸè¾“å‡º**ï¼š
```
NAME                  STATUS      PORTS
knowbooks-backend     running     0.0.0.0:1281->1281/tcp
knowbooks-frontend    running     0.0.0.0:1280->1280/tcp
```

### 2. æµ‹è¯•åç«¯

```bash
# å¥åº·æ£€æŸ¥
curl http://localhost:1281/api/health
```

**é¢„æœŸè¾“å‡º**ï¼š
```json
{"status":"ok","timestamp":"2025-12-11T..."}
```

### 3. æµ‹è¯•å‰ç«¯

```bash
# HTTPçŠ¶æ€æ£€æŸ¥
curl -I http://localhost:1280
```

**é¢„æœŸè¾“å‡º**ï¼š
```
HTTP/1.1 200 OK
Server: nginx/1.29.4
```

### 4. æµ‹è¯•å‰ç«¯ä»£ç†

```bash
# é€šè¿‡å‰ç«¯è®¿é—®åç«¯API
curl http://localhost:1280/api/health
```

**é¢„æœŸè¾“å‡º**ï¼š
```json
{"status":"ok","timestamp":"2025-12-11T..."}
```

### 5. æµè§ˆå™¨æµ‹è¯•

- **æœ¬åœ°**ï¼šhttp://localhost:1280
- **è¿œç¨‹**ï¼šhttps://vlistttbye.i234.me:12280

**é¢„æœŸç»“æœ**ï¼š
- âœ… é¡µé¢æ­£å¸¸åŠ è½½
- âœ… å¯ä»¥ç™»å½•ï¼ˆbooks/booksï¼‰
- âœ… å¯ä»¥è®¿é—®ä¹¦ç±åˆ—è¡¨
- âœ… å°é¢å›¾ç‰‡æ­£å¸¸æ˜¾ç¤º
- âœ… APIè¯·æ±‚æ­£å¸¸

---

## ğŸ“Š ç«¯å£æ˜ å°„è¯¦è§£

### Docker ç½‘ç»œæ¶æ„

```
å¤–éƒ¨è®¿é—® â†’ Docker å®¿ä¸»æœº â†’ Docker å®¹å™¨

å‰ç«¯æµç¨‹ï¼š
æµè§ˆå™¨ â†’ localhost:1280 
       â†’ Dockerå®¿ä¸»æœº:1280 
       â†’ frontendå®¹å™¨:1280
       
åç«¯æµç¨‹ï¼š
APIè¯·æ±‚ â†’ localhost:1281
        â†’ Dockerå®¿ä¸»æœº:1281
        â†’ backendå®¹å™¨:1281

å†…éƒ¨é€šä¿¡ï¼š
frontendå®¹å™¨ â†’ backend:1281 (Dockerå†…éƒ¨ç½‘ç»œ)
```

### ç«¯å£è¯´æ˜

| ç«¯å£ | ç”¨é€” | è¯´æ˜ |
|------|------|------|
| 1280 | å‰ç«¯å®¹å™¨å†…éƒ¨ | Nginxç›‘å¬ç«¯å£ |
| 1280 | å®¿ä¸»æœºå‰ç«¯ | Dockeræ˜ å°„ç«¯å£ |
| 1281 | åç«¯å®¹å™¨å†…éƒ¨ | Node.jsç›‘å¬ç«¯å£ |
| 1281 | å®¿ä¸»æœºåç«¯ | Dockeræ˜ å°„ç«¯å£ |

---

## ğŸ” ç½‘ç»œé€šä¿¡æµç¨‹

### å¤–éƒ¨è®¿é—®å‰ç«¯

```
ç”¨æˆ·æµè§ˆå™¨
  â†“
http://localhost:1280
  â†“
Dockerå®¿ä¸»æœº:1280
  â†“
frontendå®¹å™¨:1280 (Nginx)
  â†“
è¿”å›HTML/JS/CSS
```

### å‰ç«¯è°ƒç”¨åç«¯API

```
å‰ç«¯JS (axios)
  â†“
/api/books
  â†“
Nginxåå‘ä»£ç†
  â†“
http://backend:1281/api/books (Dockerå†…éƒ¨ç½‘ç»œ)
  â†“
backendå®¹å™¨:1281 (Node.js)
  â†“
è¿”å›JSONæ•°æ®
```

### å¤–éƒ¨ç›´æ¥è®¿é—®åç«¯

```
ç”¨æˆ·/å·¥å…·
  â†“
http://localhost:1281/api/health
  â†“
Dockerå®¿ä¸»æœº:1281
  â†“
backendå®¹å™¨:1281 (Node.js)
  â†“
è¿”å›JSONæ•°æ®
```

---

## âš ï¸ é‡è¦æ³¨æ„äº‹é¡¹

### 1. å¿…é¡»é‡æ–°æ„å»º

ç«¯å£ä¿®æ”¹æ¶‰åŠåˆ° Dockerfile å’Œé…ç½®æ–‡ä»¶ï¼Œå¿…é¡»é‡æ–°æ„å»ºé•œåƒï¼š

```bash
# âŒ é”™è¯¯åšæ³•ï¼šåªé‡å¯
docker-compose restart

# âœ… æ­£ç¡®åšæ³•ï¼šé‡æ–°æ„å»º
docker-compose down
docker-compose build --no-cache
docker-compose up -d
```

### 2. é…ç½®ä¸€è‡´æ€§æ£€æŸ¥

ç¡®ä¿ä»¥ä¸‹é…ç½®ä¸€è‡´ï¼š
- âœ… docker-compose.yml çš„ ports æ˜ å°„
- âœ… docker-compose.yml çš„ PORT ç¯å¢ƒå˜é‡
- âœ… backend/Dockerfile çš„ EXPOSE
- âœ… backend/src/index.ts çš„é»˜è®¤ç«¯å£
- âœ… frontend/Dockerfile çš„ EXPOSE
- âœ… frontend/nginx.conf çš„ listen å’Œ proxy_pass
- âœ… frontend/vite.config.ts çš„ proxy target

### 3. åå‘ä»£ç†é…ç½®

å¦‚æœä½¿ç”¨å¤–éƒ¨åå‘ä»£ç†ï¼ˆå¦‚Nginxã€Caddyï¼‰ï¼Œéœ€è¦ç›¸åº”ä¿®æ”¹ï¼š

**Nginx ç¤ºä¾‹**ï¼š
```nginx
# ä¿®æ”¹å‰
upstream backend {
    server localhost:1201;
}

upstream frontend {
    server localhost:1280;
}

# ä¿®æ”¹å
upstream backend {
    server localhost:1281;
}

upstream frontend {
    server localhost:1280;
}
```

### 4. é˜²ç«å¢™è§„åˆ™

å¦‚æœæœ‰é˜²ç«å¢™ï¼Œéœ€è¦å¼€æ”¾æ–°ç«¯å£ï¼š

```bash
# CentOS/RHEL
firewall-cmd --add-port=1281/tcp --permanent
firewall-cmd --reload

# Ubuntu/Debian
ufw allow 1281/tcp

# æ£€æŸ¥
netstat -tlnp | grep -E "1280|1281"
```

---

## ğŸ› å¸¸è§é—®é¢˜

### Q1: ç«¯å£è¢«å ç”¨

**é—®é¢˜**ï¼šå¯åŠ¨æ—¶æç¤ºç«¯å£è¢«å ç”¨

**è§£å†³**ï¼š
```bash
# æ£€æŸ¥å ç”¨
lsof -i :1280
lsof -i :1281

# åœæ­¢å ç”¨è¿›ç¨‹
kill -9 <PID>

# æˆ–ä¿®æ”¹ç«¯å£
# åœ¨ docker-compose.yml ä¸­ä¿®æ”¹æ˜ å°„ç«¯å£
ports:
  - "12800:1280"  # ä½¿ç”¨å…¶ä»–å®¿ä¸»æœºç«¯å£
```

### Q2: å®¹å™¨æ— æ³•é€šä¿¡

**é—®é¢˜**ï¼šå‰ç«¯æ— æ³•è®¿é—®åç«¯ï¼ŒNginx 502é”™è¯¯

**æ£€æŸ¥**ï¼š
```bash
# 1. æ£€æŸ¥å®¹å™¨æ˜¯å¦è¿è¡Œ
docker-compose ps

# 2. æ£€æŸ¥ç½‘ç»œ
docker network inspect knowbooks_knowbooks-network

# 3. åœ¨å‰ç«¯å®¹å™¨å†…æµ‹è¯•åç«¯
docker exec -it knowbooks-frontend sh
wget -O- http://backend:1281/api/health

# 4. æ£€æŸ¥åç«¯æ—¥å¿—
docker-compose logs backend
```

### Q3: æµè§ˆå™¨æ— æ³•è®¿é—®

**é—®é¢˜**ï¼šhttp://localhost:1280 æ— æ³•è®¿é—®

**æ£€æŸ¥**ï¼š
```bash
# 1. å®¹å™¨æ˜¯å¦è¿è¡Œ
docker-compose ps

# 2. ç«¯å£æ˜¯å¦ç›‘å¬
netstat -tlnp | grep 1280

# 3. å®¹å™¨å†…éƒ¨æ˜¯å¦æ­£å¸¸
docker exec -it knowbooks-frontend wget -O- http://localhost:1280

# 4. æŸ¥çœ‹å‰ç«¯æ—¥å¿—
docker-compose logs frontend
```

### Q4: å¼€å‘ç¯å¢ƒé…ç½®

**é—®é¢˜**ï¼šæœ¬åœ°å¼€å‘å¦‚ä½•é…ç½®ç«¯å£ï¼Ÿ

**è§£å†³**ï¼š
```bash
# åç«¯ï¼ˆåœ¨backendç›®å½•ï¼‰
PORT=1281 npm run dev

# å‰ç«¯ï¼ˆåœ¨frontendç›®å½•ï¼‰
npm run dev
# å‰ç«¯ä¼šè‡ªåŠ¨ä»£ç†åˆ° localhost:1281
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- **è¯¦ç»†è¯´æ˜**ï¼š`ç«¯å£ä¿®æ”¹è¯´æ˜.md`
- **å¿«é€Ÿå‚è€ƒ**ï¼š`ç«¯å£ä¿®æ”¹-å¿«é€Ÿå‚è€ƒ.md`
- **éƒ¨ç½²è„šæœ¬**ï¼š`redeploy.sh`, `deploy-quick.sh`
- **çŠ¶æ€æ£€æŸ¥**ï¼š`docker-status.sh`
- **æ—¥å¿—æŸ¥çœ‹**ï¼š`docker-logs.sh`

---

## ğŸ‰ æ€»ç»“

### å®Œæˆçš„å·¥ä½œ

- âœ… ä¿®æ”¹äº† **8ä¸ªæ–‡ä»¶** çš„ç«¯å£é…ç½®
- âœ… åˆ›å»ºäº† **3ä¸ªæ–‡æ¡£** è¯´æ˜ä¿®æ”¹å†…å®¹
- âœ… ç¼–è¯‘æµ‹è¯•é€šè¿‡ï¼ˆå‰ç«¯+åç«¯ï¼‰
- âœ… é…ç½®ä¸€è‡´æ€§æ£€æŸ¥å®Œæˆ

### ç«¯å£ç»Ÿä¸€

| æœåŠ¡ | å®¹å™¨å†… | å®¿ä¸»æœº | è¯´æ˜ |
|------|-------|--------|------|
| å‰ç«¯ | 1280 | 1280 | ç»Ÿä¸€ä½¿ç”¨1280 |
| åç«¯ | 1281 | 1281 | ç»Ÿä¸€ä½¿ç”¨1281 |

### ä¼˜åŠ¿

- ğŸ¯ **ç«¯å£ç»Ÿä¸€**ï¼šå®¹å™¨å†…å¤–ç«¯å£ä¸€è‡´ï¼Œæ˜“äºç†è§£
- ğŸ“ **é…ç½®æ¸…æ™°**ï¼šæ‰€æœ‰é…ç½®ç»Ÿä¸€ä¿®æ”¹å®Œæˆ
- ğŸš€ **æ˜“äºéƒ¨ç½²**ï¼šæä¾›å¤šç§éƒ¨ç½²è„šæœ¬
- ğŸ” **æ˜“äºè°ƒè¯•**ï¼šç«¯å£æ˜ å°„å…³ç³»ç®€å•æ˜äº†

---

## ğŸš€ ä¸‹ä¸€æ­¥

### ç«‹å³éƒ¨ç½²

```bash
cd /Users/ttbye/MyCODE/KnowBooks
./redeploy.sh
```

### è¿œç¨‹éƒ¨ç½²

```bash
# SSHåˆ°æœåŠ¡å™¨
ssh user@vlistttbye.i234.me
cd /volume5/docker/bookpath/install
git pull
./deploy-quick.sh
```

### éªŒè¯æµ‹è¯•

```bash
# éƒ¨ç½²åæµ‹è¯•
./docker-status.sh
curl http://localhost:1281/api/health
curl http://localhost:1280/api/health
```

---

**å®Œæˆæ—¥æœŸ**ï¼š2025-12-11  
**ç‰ˆæœ¬**ï¼šv1.3.0  
**çŠ¶æ€**ï¼šâœ… å·²å®Œæˆæ‰€æœ‰ä¿®æ”¹å’Œæµ‹è¯•  
**å¾…åŠ**ï¼šéƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ

ğŸ‰ **æ‰€æœ‰ç«¯å£é…ç½®å·²å®Œæˆï¼å‡†å¤‡éƒ¨ç½²ï¼**
