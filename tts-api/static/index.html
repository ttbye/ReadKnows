<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TTS API æµ‹è¯•é¡µé¢</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 30px;
        }
        
        h1 {
            color: #333;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        @media (max-width: 768px) {
            .row {
                grid-template-columns: 1fr;
            }
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .audio-player {
            margin-top: 30px;
            padding: 20px;
            background: #f5f5f5;
            border-radius: 8px;
        }
        
        audio {
            width: 100%;
            margin-top: 10px;
        }
        
        .status {
            margin-top: 20px;
            padding: 12px;
            border-radius: 8px;
            display: none;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .api-key-group {
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #ffc107;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
            vertical-align: middle;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¤ TTS API æµ‹è¯•é¡µé¢</h1>
        
        <div class="api-key-group">
            <div class="form-group">
                <label for="apiKey">ğŸ”‘ API Key <span style="color: #dc3545;">*</span> (å¦‚æœæœåŠ¡å¯ç”¨äº† API Key éªŒè¯)</label>
                <input type="text" id="apiKey" placeholder="è¾“å…¥ API Key" autocomplete="off">
                <button type="button" onclick="loadModels()" style="margin-top: 10px; width: auto; padding: 8px 16px; font-size: 14px;">é‡æ–°åŠ è½½æ¨¡å‹åˆ—è¡¨</button>
            </div>
        </div>
        
        <div class="form-group">
            <label for="model">é€‰æ‹© TTS æ¨¡å‹</label>
            <select id="model">
                <option value="">åŠ è½½ä¸­...</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="voice">é€‰æ‹©è¯­éŸ³</label>
            <select id="voice" disabled>
                <option value="">è¯·å…ˆé€‰æ‹©æ¨¡å‹</option>
            </select>
        </div>
        
        <div class="row">
            <div class="form-group">
                <label for="speed">è¯­é€Ÿ (0.5 - 2.0)</label>
                <input type="number" id="speed" value="1.0" min="0.5" max="2.0" step="0.1">
            </div>
            <div class="form-group">
                <label for="emotion">æƒ…æ„Ÿ (ä»… CosyVoice)</label>
                <select id="emotion">
                    <option value="">é»˜è®¤</option>
                    <option value="happy">å¼€å¿ƒ</option>
                    <option value="sad">æ‚²ä¼¤</option>
                    <option value="angry">æ„¤æ€’</option>
                    <option value="neutral">ä¸­æ€§</option>
                </select>
            </div>
        </div>
        
        <div class="form-group">
            <label for="text">è¾“å…¥æ–‡æœ¬</label>
            <textarea id="text" placeholder="è¾“å…¥è¦è½¬æ¢ä¸ºè¯­éŸ³çš„æ–‡æœ¬...">ä½ å¥½ï¼Œè¿™æ˜¯ä¸€ä¸ª TTS æµ‹è¯•ã€‚</textarea>
        </div>
        
        <button id="synthesizeBtn" onclick="synthesize()">
            ğŸµ ç”Ÿæˆè¯­éŸ³
        </button>
        
        <div id="status" class="status"></div>
        
        <div class="audio-player" id="audioPlayer" style="display: none;">
            <h3>ç”Ÿæˆçš„éŸ³é¢‘ï¼š</h3>
            <audio id="audio" controls></audio>
        </div>
    </div>
    
    <script>
        const API_BASE = window.location.origin;
        let currentModel = '';
        let currentVoices = [];
        
        // åŠ è½½æ¨¡å‹åˆ—è¡¨
        async function loadModels() {
            try {
                const response = await fetch(`${API_BASE}/api/tts/models`, {
                    headers: getHeaders()
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ detail: `HTTP ${response.status}` }));
                    throw new Error(errorData.detail || `HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                // éªŒè¯æ•°æ®æ ¼å¼
                if (!data || !Array.isArray(data.models)) {
                    throw new Error('API è¿”å›çš„æ•°æ®æ ¼å¼ä¸æ­£ç¡®');
                }
                
                const modelSelect = document.getElementById('model');
                modelSelect.innerHTML = '<option value="">è¯·é€‰æ‹©æ¨¡å‹</option>';
                
                data.models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.id;
                    option.textContent = `${model.name} (${model.type}) ${model.available ? 'âœ…' : 'âŒ'}`;
                    option.disabled = !model.available;
                    modelSelect.appendChild(option);
                });
                
                modelSelect.addEventListener('change', async (e) => {
                    currentModel = e.target.value;
                    if (currentModel) {
                        await loadVoices(currentModel);
                    } else {
                        const voiceSelect = document.getElementById('voice');
                        voiceSelect.innerHTML = '<option value="">è¯·å…ˆé€‰æ‹©æ¨¡å‹</option>';
                        voiceSelect.disabled = true;
                    }
                });
            } catch (error) {
                const errorMessage = error.message;
                showStatus('åŠ è½½æ¨¡å‹åˆ—è¡¨å¤±è´¥: ' + errorMessage, 'error');
                const modelSelect = document.getElementById('model');
                modelSelect.innerHTML = '<option value="">åŠ è½½å¤±è´¥</option>';
                
                // å¦‚æœæ˜¯ API Key é”™è¯¯ï¼Œèšç„¦åˆ°è¾“å…¥æ¡†å¹¶é«˜äº®æç¤º
                if (errorMessage.includes('API Key') || errorMessage.includes('401')) {
                    hasApiKeyError = true;
                    const apiKeyInput = document.getElementById('apiKey');
                    apiKeyInput.focus();
                    apiKeyInput.style.borderColor = '#dc3545';
                    apiKeyInput.style.boxShadow = '0 0 0 0.2rem rgba(220, 53, 69, 0.25)';
                    
                    // ç§»é™¤é«˜äº®æ ·å¼
                    setTimeout(() => {
                        apiKeyInput.addEventListener('input', function() {
                            this.style.borderColor = '';
                            this.style.boxShadow = '';
                        }, { once: true });
                    }, 100);
                }
            }
        }
        
        // åŠ è½½è¯­éŸ³åˆ—è¡¨
        async function loadVoices(model) {
            try {
                const response = await fetch(`${API_BASE}/api/tts/voices?model=${model}`, {
                    headers: getHeaders()
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ detail: `HTTP ${response.status}` }));
                    throw new Error(errorData.detail || `HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                // éªŒè¯æ•°æ®æ ¼å¼
                if (!data || !Array.isArray(data.voices)) {
                    throw new Error('API è¿”å›çš„æ•°æ®æ ¼å¼ä¸æ­£ç¡®');
                }
                
                const voiceSelect = document.getElementById('voice');
                voiceSelect.innerHTML = '<option value="">è¯·é€‰æ‹©è¯­éŸ³</option>';
                voiceSelect.disabled = false;
                
                currentVoices = data.voices;
                data.voices.forEach(voice => {
                    const option = document.createElement('option');
                    option.value = voice.id;
                    option.textContent = `${voice.name} ${voice.referenceAudio ? '(å£°éŸ³å…‹éš†)' : ''}`;
                    voiceSelect.appendChild(option);
                });
            } catch (error) {
                showStatus('åŠ è½½è¯­éŸ³åˆ—è¡¨å¤±è´¥: ' + error.message, 'error');
                const voiceSelect = document.getElementById('voice');
                voiceSelect.innerHTML = '<option value="">åŠ è½½å¤±è´¥</option>';
                voiceSelect.disabled = true;
            }
        }
        
        // ç”Ÿæˆè¯­éŸ³
        async function synthesize() {
            const model = document.getElementById('model').value;
            const voice = document.getElementById('voice').value;
            const text = document.getElementById('text').value;
            const speed = parseFloat(document.getElementById('speed').value);
            const emotion = document.getElementById('emotion').value;
            
            if (!model || !voice || !text) {
                showStatus('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ', 'error');
                return;
            }
            
            const btn = document.getElementById('synthesizeBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span>ç”Ÿæˆä¸­...';
            
            try {
                const selectedVoice = currentVoices.find(v => v.id === voice);
                const body = {
                    text,
                    model,
                    voice,
                    speed,
                };
                
                if (selectedVoice?.referenceAudio) {
                    body.referenceAudio = selectedVoice.referenceAudio;
                }
                
                if (emotion && model === 'cosyvoice') {
                    body.emotion = emotion;
                }
                
                const response = await fetch(`${API_BASE}/api/tts/synthesize`, {
                    method: 'POST',
                    headers: {
                        ...getHeaders(),
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(body),
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || `HTTP ${response.status}`);
                }
                
                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                
                const audio = document.getElementById('audio');
                audio.src = url;
                document.getElementById('audioPlayer').style.display = 'block';
                
                showStatus('è¯­éŸ³ç”ŸæˆæˆåŠŸï¼', 'success');
            } catch (error) {
                showStatus('ç”Ÿæˆå¤±è´¥: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'ğŸµ ç”Ÿæˆè¯­éŸ³';
            }
        }
        
        // è·å–è¯·æ±‚å¤´
        function getHeaders() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const headers = {};
            if (apiKey) {
                headers['X-API-Key'] = apiKey;
            }
            return headers;
        }
        
        // API Key è¾“å…¥æ¡†å˜åŒ–æ—¶ï¼Œå¦‚æœä¹‹å‰æœ‰é”™è¯¯ï¼Œè‡ªåŠ¨é‡æ–°åŠ è½½
        let hasApiKeyError = false;
        
        // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
            status.style.display = 'block';
            
            if (type === 'success') {
                setTimeout(() => {
                    status.style.display = 'none';
                }, 3000);
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', () => {
            // è®¾ç½® API Key è¾“å…¥æ¡†çš„è‡ªåŠ¨é‡è¯•åŠŸèƒ½
            const apiKeyInput = document.getElementById('apiKey');
            apiKeyInput.addEventListener('blur', function() {
                if (hasApiKeyError && this.value.trim()) {
                    hasApiKeyError = false;
                    loadModels();
                }
            });
            
            // æ£€æŸ¥æ˜¯å¦éœ€è¦ API Keyï¼ˆé€šè¿‡å°è¯•è®¿é—®å¥åº·æ£€æŸ¥ç«¯ç‚¹ï¼‰
            loadModels();
        });
    </script>
</body>
</html>

